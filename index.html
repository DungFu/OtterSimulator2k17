<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Otter Simuator 2k17</title>
</head>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pixi.js/4.3.5/pixi.min.js"></script>
  <script src="smooth.js"></script>
  <link rel="stylesheet" href="master.css">
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="96x96" href="/favicon-96x96.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<body>
  <script type="text/javascript">
    var type = "WebGL"
    if(!PIXI.utils.isWebGLSupported()){
      type = "canvas"
    }

    PIXI.utils.sayHello(type)

    //Create the renderer

    var renderer = PIXI.autoDetectRenderer(256, 256, {transparent: true});
    renderer.view.style.position = "absolute";
    renderer.view.style.display = "block";
    renderer.autoResize = true;
    renderer.resize(window.innerWidth, window.innerHeight);

    //Add the canvas to the HTML document
    document.body.appendChild(renderer.view);

    //Create a container object called the `stage`
    var stage = new PIXI.Container();

    //Tell the `renderer` to `render` the `stage`
    renderer.render(stage);

    window.addEventListener("resize", function(event) {
      renderer.resize(window.innerWidth, window.innerHeight);
    });

    PIXI.loader
    .add([
      "img/otter_sprite.png",
      "img/bang.png"
    ])
    .load(setup);

    var mouseX = 0;
    var mouseY = 0;

    var otterSpriteSize = 175;

    var otterPositions = {
      "idle": [[0,0], [4,0], [2,1], [3,1]],
      "scared": [[1,0]],
      "hide": [[2,0]],
      "standing": [[3,0]],
      "struggle": [[0,2]],
      "grab": [[1,2]],
      "swim_left": [[0,1], [5,1], [6,1], [9,2]],
      "swim_down": [[1,1], [3,2], [4,2], [8,0], [9,0], [8,1], [5,2], [7,2]],
      "swim_right": [[4,1], [5,0], [7,1], [8,2]],
      "swim_up": [[2,2], [6,0], [7,0], [9,1], [6,2]],
    }

    var otterPathPoints = [
      [0.2, 0.2],
      [0.1, 0.4],
      [0.3, 0.6],
      [0.4, 0.8],
      [0.5, 0.5],
      [0.8, 0.8],
      [0.7, 0.6],
      [0.8, 0.3],
      [0.5, 0.2],
      [0.2, 0.2]
    ];

    var otterPath = Smooth(otterPathPoints, {
        method: Smooth.METHOD_LANCZOS
    });

    var otterPathTime = 15000;
    var pathProgress = 0;

    var otterTexture = null;
    var otter = null;
    var lastOtterUpdate = 0;
    var nextOtterUpdate = 0;
    var otterMode = "swim_";
    var otterModeRerender = false;
    var lastOtterMode;
    var prevRenderTime = Date.now();
    var otterBusy = false;
    var bangText = null;
    var bangTextLastTime = 0;
    var game = "bang";
    var enrichmentScore = 0;

    function gameLoop() {
      requestAnimationFrame(gameLoop);
      var tDelta = Date.now() - prevRenderTime;
      if (otterMode.includes("swim_") && game == "bang") {
        otter.vx = 0;
        otter.vy = 0;
        pathProgress += tDelta / otterPathTime;
        pathProgress = pathProgress % 1;
        var index = pathProgress * (otterPathPoints.length - 1);
        var otterPosition = otterPath(index);
        otter.position.set(
          otterPosition[0] * window.innerWidth - otterSpriteSize / 2,
          otterPosition[1] * window.innerHeight - otterSpriteSize / 2
        );
        var before = otterPath(index - 0.1);
        otterMode = getOtterDirection(before, otterPosition);
      } else if (game == "enrichment") {
        var currentX = otter.position.x + otterSpriteSize / 2;
        var currentY = otter.position.y + otterSpriteSize / 2;
        var divisor = Math.sqrt(Math.pow(mouseX - currentX, 2) + Math.pow(mouseY - currentY, 2));
        if (divisor > 1) {
          otter.vx = (mouseX - currentX) / divisor * 2;
          otter.vy = (mouseY - currentY) / divisor * 2;
          if (!otterMode.includes("swim_")) {
            otterModeRerender = true;
          }
          otterMode = getOtterDirection([currentX, currentY], [mouseX, mouseY]);
        } else {
          otter.vx = 0;
          otter.vy = 0;
          if (otterMode != "grab") {
            enrichmentScore++;
            var enrichmentScoreDiv = document.getElementById('otter_enrichment_score');
            enrichmentScoreDiv.innerHTML = "Enriched: " + enrichmentScore;
          }
          otterMode = "grab";
          if (enrichmentScore > 10) {
            game = "bang";
            otterMode = "swim_";
            var enrichmentButton = document.getElementById('otter_enrichment');
            enrichmentButton.style.visibility = 'visible';
            var enrichmentScoreDiv = document.getElementById('otter_enrichment_score');
            enrichmentScoreDiv.style.visibility = 'hidden';
            otterModeRerender = true;
          }
        }
        otter.x += otter.vx;
        otter.y += otter.vy;
        
      }
      runMode();
      if (Date.now() - bangTextLastTime <= 500) {
        bangText.alpha = 1 - (Date.now() - bangTextLastTime) / 500;
      } else {
        bangText.alpha = 0;
      }
      renderer.render(stage);
      prevRenderTime = Date.now();
    }

    function getOtterDirection(oldPos, newPos) {
      deltax = newPos[0] - oldPos[0];
      deltay = newPos[1] - oldPos[1];
      if (Math.abs(deltax) > Math.abs(deltay)) {
        if (deltax < 0) {
          return "swim_left";
        } else {
          return "swim_right";
        }
      } else {
        if (deltay < 0) {
          return "swim_up";
        } else {
          return "swim_down";
        }
      }
    }

    function setup() {
      otterTexture = PIXI.loader.resources["img/otter_sprite.png"].texture;
      var rectangle = new PIXI.Rectangle(0, 0, otterSpriteSize, otterSpriteSize);
      otterTexture.frame = rectangle;
      otter = new PIXI.Sprite(otterTexture);
      stage.addChild(otter);

      var bangTextTexture = PIXI.loader.resources["img/bang.png"].texture;
      bangText = new PIXI.Sprite(bangTextTexture);
      bangText.alpha = 0;
      stage.addChild(bangText);

      renderer.render(stage);
      gameLoop();

      setTimeout(function() {
        goIdle();
      }, otterPathTime * Math.random() + otterPathTime)
    }

    function goIdle() {
      if (otterBusy) {
        return;
      }
      var prevMode = otterMode;
      otterBusy = true;
      otterMode = "idle";
      otterModeRerender = true;
      setTimeout(function() {
        otterBusy = false;
        otterMode = prevMode;
        otterModeRerender = true;
        setTimeout(function() {
          goIdle();
        }, otterPathTime * Math.random() + otterPathTime)
      }, 3000 * Math.random() + 3000);
    }

    function runMode() {
      if (otterModeRerender || lastOtterUpdate + nextOtterUpdate < Date.now()) {
        var index = Math.floor((Math.random() * otterPositions[otterMode].length));
        var rectangle = new PIXI.Rectangle(
          otterPositions[otterMode][index][0]*otterSpriteSize,
          otterPositions[otterMode][index][1]*otterSpriteSize,
          otterSpriteSize,
          otterSpriteSize);
        var timer = 800;
        if (otterMode.includes("swim_")) {
          timer = 200;
        }
        otterTexture.frame = rectangle;
        lastOtterUpdate = Date.now();
        nextOtterUpdate = Math.random() * timer + timer;
        otterModeRerender = false;
      }
    }

    function launchEnrichment() {
      var enrichmentButton = document.getElementById('otter_enrichment');
      enrichmentButton.style.visibility = 'hidden';
      var enrichmentScoreDiv = document.getElementById('otter_enrichment_score');
      enrichmentScoreDiv.style.visibility = 'visible';
      enrichmentScoreDiv.innerHTML = "Enriched: " + enrichmentScore;
      game = "enrichment";
      enrichmentScore = 0;
    }

    document.onmousemove = function(e) {
      mouseX = e.pageX;
      mouseY = e.pageY;
      if (bangText !== null) {
        bangText.position.set(mouseX - 100, mouseY - 100);
      }
    } 

    renderer.view.onmousedown = function(e) {
      if (otterBusy) {
        return;
      }
      if (game == "bang") {
        bangText.alpha = 1;
        bangTextLastTime = Date.now();
        var prevMode = otterMode;
        otterBusy = true;
        otterMode = "hide";
        otterModeRerender = true;
        setTimeout(function() {
          otterMode = "scared";
          otterModeRerender = true;
          setTimeout(function() {
            otterMode = "hide";
            otterModeRerender = true;
            setTimeout(function() {
              otterBusy = false;
              otterMode = prevMode;
              otterModeRerender = true;
            }, 2000);
          }, 500);
        }, 2000);
      }
    }
  </script>
  <div id="otter_enrichment" onclick="launchEnrichment()">Otter Enrichment!</div>
  <div id="otter_enrichment_score"></div>
</body>
</html>