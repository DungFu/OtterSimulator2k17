<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Hello World</title>
</head>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pixi.js/4.3.5/pixi.min.js"></script>
  <script src="smooth.js"></script>
  <style>* {padding: 0; margin: 0}</style>
  <link rel="stylesheet" href="master.css">
<body>
  <script type="text/javascript">
    var type = "WebGL"
    if(!PIXI.utils.isWebGLSupported()){
      type = "canvas"
    }

    PIXI.utils.sayHello(type)

    //Create the renderer

    var renderer = PIXI.autoDetectRenderer(256, 256, {transparent: true});
    renderer.view.style.position = "absolute";
    renderer.view.style.display = "block";
    renderer.autoResize = true;
    renderer.resize(window.innerWidth, window.innerHeight);

    //Add the canvas to the HTML document
    document.body.appendChild(renderer.view);

    //Create a container object called the `stage`
    var stage = new PIXI.Container();

    //Tell the `renderer` to `render` the `stage`
    renderer.render(stage);

    window.addEventListener("resize", function(event) {
      renderer.resize(window.innerWidth, window.innerHeight);
    });

    PIXI.loader
    .add([
      "img/otter_sprite.png",
      "img/bang.png"
    ])
    .load(setup);

    var mouseX = 0;
    var mouseY = 0;

    var otterSpriteSize = 175;

    var otterPositions = {
      "idle": [[0,0], [4,0], [2,1], [3,1], [1,2]],
      "scared": [[1,0]],
      "hide": [[2,0]],
      "standing": [[3,0]],
      "struggle": [[0,2]],
      "swim_left": [[0,1], [5,1], [6,1], [9,2]],
      "swim_down": [[1,1], [3,2], [4,2], [8,0], [9,0], [8,1], [5,2], [7,2]],
      "swim_right": [[4,1], [5,0], [7,1], [8,2]],
      "swim_up": [[2,2], [6,0], [7,0], [9,1], [6,2]],
    }

    var otterPathPoints = [
      [0.2, 0.2],
      [0.1, 0.4],
      [0.3, 0.6],
      [0.4, 0.8],
      [0.5, 0.5],
      [0.8, 0.8],
      [0.7, 0.6],
      [0.8, 0.3],
      [0.5, 0.2],
      [0.2, 0.2]
    ];

    var otterPath = Smooth(otterPathPoints, {
        method: Smooth.METHOD_LANCZOS
    });

    var otterPathTime = 15000;
    var pathProgress = 0;

    var otterTexture = null;
    var otter = null;
    var lastOtterUpdate = 0;
    var nextOtterUpdate = 0;
    var otterMode = "swim_";
    var otterModeRerender = false;
    var lastOtterMode;
    var prevRenderTime = Date.now();
    var otterBusy = false;
    var bangText = null;
    var bangTextLastTime = 0;

    function gameLoop() {
      requestAnimationFrame(gameLoop);
      var tDelta = Date.now() - prevRenderTime;
      if (otterMode.includes("swim_")) {
        pathProgress += tDelta/otterPathTime;
        pathProgress = pathProgress % 1;
        var index = pathProgress * (otterPathPoints.length - 1);
        var otterPosition = otterPath(index);
        otter.position.set(
          otterPosition[0] * window.innerWidth - otterSpriteSize/2,
          otterPosition[1] * window.innerHeight - otterSpriteSize/2
        );
        var before = otterPath(index - 0.1);
        deltax = otterPosition[0] - before[0];
        deltay = otterPosition[1] - before[1];
        if (Math.abs(deltax) > Math.abs(deltay)) {
          if (deltax < 0) {
            otterMode = "swim_left";
          } else {
            otterMode = "swim_right";
          }
        } else {
          if (deltay < 0) {
            otterMode = "swim_up";
          } else {
            otterMode = "swim_down";
          }
        }
      }
      runMode();
      if (Date.now() - bangTextLastTime <= 500) {
        bangText.alpha = 1 - (Date.now() - bangTextLastTime) / 500;
      } else {
        bangText.alpha = 0;
      }
      renderer.render(stage);
      prevRenderTime = Date.now();
    }

    function setup() {
      otterTexture = PIXI.loader.resources["img/otter_sprite.png"].texture;
      var rectangle = new PIXI.Rectangle(0, 0, otterSpriteSize, otterSpriteSize);
      otterTexture.frame = rectangle;
      otter = new PIXI.Sprite(otterTexture);
      stage.addChild(otter);

      var bangTextTexture = PIXI.loader.resources["img/bang.png"].texture;
      bangText = new PIXI.Sprite(bangTextTexture);
      bangText.alpha = 0;
      stage.addChild(bangText);

      renderer.render(stage);
      gameLoop();

      setTimeout(function() {
        goIdle();
      }, otterPathTime * Math.random() + otterPathTime)
    }

    function goIdle() {
      if (otterBusy) {
        return;
      }
      var prevMode = otterMode;
      otterBusy = true;
      otterMode = "idle";
      otterModeRerender = true;
      setTimeout(function() {
        otterBusy = false;
        otterMode = prevMode;
        otterModeRerender = true;
        setTimeout(function() {
          goIdle();
        }, otterPathTime * Math.random() + otterPathTime)
      }, 3000 * Math.random() + 3000);
    }

    function runMode() {
      if (otterModeRerender || lastOtterUpdate + nextOtterUpdate < Date.now()) {
        var index = Math.floor((Math.random() * otterPositions[otterMode].length));
        var rectangle = new PIXI.Rectangle(
          otterPositions[otterMode][index][0]*otterSpriteSize,
          otterPositions[otterMode][index][1]*otterSpriteSize,
          otterSpriteSize,
          otterSpriteSize);
        var timer = 800;
        if (otterMode.includes("swim_")) {
          timer = 200;
        }
        otterTexture.frame = rectangle;
        lastOtterUpdate = Date.now();
        nextOtterUpdate = Math.random() * timer + timer;
        otterModeRerender = false;
      }
    }

    document.onmousemove = function(e) {
      mouseX = e.pageX;
      mouseY = e.pageY;
      bangText.position.set(mouseX - 100, mouseY - 100);
    }

    document.onmousedown = function(e) {
      if (otterBusy) {
        return;
      }
      bangText.alpha = 1;
      bangTextLastTime = Date.now();
      var prevMode = otterMode;
      otterBusy = true;
      otterMode = "hide";
      otterModeRerender = true;
      setTimeout(function() {
        otterMode = "scared";
        otterModeRerender = true;
        setTimeout(function() {
          otterMode = "hide";
          otterModeRerender = true;
          setTimeout(function() {
            otterBusy = false;
            otterMode = prevMode;
            otterModeRerender = true;
          }, 2000);
        }, 500);
      }, 2000);
    }

  </script>
</body>
</html>